# -*- coding: utf-8 -*-
"""Daily Stock Notifications2

Automatically generated by Colab.

Original file is located at
"""

import datetime
import pandas as pd
import numpy as np
from scipy.stats import norm
import twstock

# 1. è³‡æ–™ä¸‹è¼‰è™•ç†æ¨¡çµ„
def get_stock_data(ticker, start_date):
    stock = twstock.Stock(ticker)
    stock_data = stock.fetch_from(start_date.year, start_date.month)
    df = pd.DataFrame({
        'Date': [d.date for d in stock_data],
        'Open': [d.open for d in stock_data],
        'High': [d.high for d in stock_data],
        'Low': [d.low for d in stock_data],
        'Close': [d.close for d in stock_data],
        'Volume': [d.capacity for d in stock_data]
    }).set_index('Date').sort_index()
    return df

# 2. æ–¹æ³• Aï¼šZ-score é«˜é»é æ¸¬
def zscore_peak_prediction(df, window=20, threshold=0.9):
    ma = df['Close'].rolling(window).mean()
    std = df['Close'].rolling(window).std()
    z = (df['Close'] - ma) / std
    prob = norm.cdf(z)
    df['Z_Score'] = z
    df['Z_Peak_Prob'] = prob
    df['Z_Peak'] = prob > threshold
    return df

def pressure_peak_prediction(df, lookback=30, z_window=60, threshold=0.9):
    # å‰é«˜å£“åŠ›ï¼ˆä¸å«ä»Šæ—¥ï¼‰
    df['Prev_High'] = df['High'].shift(1).rolling(window=lookback).max()

    # åé›¢å£“åŠ›ç¨‹åº¦
    df['Pressure_Deviation'] = (df['Close'] - df['Prev_High']) / df['Prev_High']

    # è¨ˆç®—å£“åŠ› Z-score èˆ‡æ©Ÿç‡
    mean_dev = df['Pressure_Deviation'].rolling(window=z_window).mean()
    std_dev = df['Pressure_Deviation'].rolling(window=z_window).std()

    df['Pressure_Z'] = (df['Pressure_Deviation'] - mean_dev) / std_dev
    df['Pressure_Prob'] = norm.cdf(df['Pressure_Z'])  # è¶Šé«˜ä»£è¡¨è¶Šçªç ´

    df['Pressure_Peak'] = df['Pressure_Prob'] > threshold
    return df

# 3. å¯¦éš›é«˜é»æ¨™è¨˜ï¼ˆå¯å…±ç”¨ï¼‰
def label_actual_peaks(df, peak_window=10):
    df['Actual_Peak'] = df['Close'] == df['Close'].rolling(peak_window, center=True).max()
    return df

# 4. é æ¸¬ vs å¯¦éš› æ¯”å°
def evaluate_prediction(df, pred_col):
    return (df[pred_col] & df['Actual_Peak']).sum(), df[pred_col].sum(), df['Actual_Peak'].sum()

def run_all(tickers):
    results = []
    start_date = datetime.date.today() - datetime.timedelta(days=730)
    summary_lines = []
    for ticker in tickers:
        try:
            df = get_stock_data(ticker, start_date)

            # æ–¹æ³• A: Z-score
            df = zscore_peak_prediction(df)
            # æ–¹æ³• B: å£“åŠ›çªç ´æ³•
            df = pressure_peak_prediction(df)

            # å¯¦éš›é«˜é»
            # df = label_actual_peaks(df)
            # å–æœ€æ–°ä¸€ç­†è³‡æ–™
            price = round(df['Close'].iloc[-1], 2)
            prob_z = round(df['Z_Peak_Prob'].iloc[-1], 3)
            prob_pressure = round(df['Pressure_Prob'].iloc[-1], 3)

            line = f"ğŸ“Œ {ticker}ï½œæ”¶ç›¤ï¼š{price}ï½œZåˆ†æ•¸æ©Ÿç‡ï¼š{prob_z}ï½œå£“åŠ›æ©Ÿç‡ï¼š{prob_pressure}"
            summary_lines.append(line)


        except Exception as e:
            print(f"{ticker} ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")

    # åŒ¯ç¸½çµæœ
    # summary = pd.DataFrame(results)
    # summary.to_csv("all_results_summary.csv", index=False)
    # files.download("all_results_summary.csv")

    # åˆä½µæˆå®Œæ•´è¨Šæ¯
    today = datetime.date.today().strftime('%Y-%m-%d')
    return f"ğŸ“Šã€é«˜é»é æ¸¬ç¸½è¦½ã€‘{today}\n\n" + "\n\n".join(summary_lines)

import requests

tickers = ['2317', '2303', '2330']  # è‡ªè¡Œä¿®æ”¹ä»£ç¢¼æ¸…å–®
full_message = run_all(tickers)

print(full_message)

# ç”¨ä½ è‡ªå·±çš„ Token å’Œ User ID
channel_access_token = os.getenv("LINE_CHANNEL_TOKKEN")
user_id = os.getenv("LINE_USER_ID")

headers = {
    "Content-Type": "application/json",
    "Authorization": f"Bearer {channel_access_token}"
}

payload = {
    "to": user_id,
    "messages": [{
        "type": "text",
        "text": full_message
    }]
}

response = requests.post("https://api.line.me/v2/bot/message/push", headers=headers, json=payload)

if response.status_code == 200:
    print("âœ… æˆåŠŸå‚³é€è¨Šæ¯åˆ° LINE")
else:
    print(f"âŒ å‚³é€å¤±æ•—ï¼š{response.text}")
